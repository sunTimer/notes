# 平等计划涉及专线探测系统改造 

## 1. 需求分析
从任务执行角度出发，可把专线探测模块分为如下四个模块：
1. 专线拉取任务
2. 专线探测任务（发送`telnet`命令）
3. 专线切断任务
4. 专线恢复任务

其中，任务1、2、3为通过调用`basedata`暴露出的`dubbo`接口来完成相关任务。从对`basedata`数据库读写的角度来讲，任务1只有数据库的读操作，任务2、3会涉及到对`basedata`库的写入。`basedata`数据库有两个：主库和备库，分别在10机房和20机房部署。

当主库宕机时，会由`DBA`将备库切换为主库。而专线探测任务调用`basedata`接口中的配置中，读任务默认为本地`local`库，即读取该任务-该机房-该数据库，而写任务调用的`basedata`是写死在配置文件中，默认为`10`机房的主库。因此，这导致主库宕机之后，专线探测并无感知，依然会往主库发送写任务，这就会造成写失败。

## 2. 设计实现

**方案**：

在容器中注入两个`zk`注册中心，每个注册中心分别注入一个`channelService`接口。实现一个定时任务，定期调用接口（该接口可以获取当前主库的信息），获取主库信息。

>专线任务不直接注入`channelService`，而是通过一个`Selector`来实现跟该接口的解耦，调用透明。专线任务只调用`selector`，由`selector`负责去决定调用哪个`channelService`接口。

**设计图**：

![设计图](C:\Users\shixu\AppData\Local\Temp\1530508087406.png)

## 3. 任务排期

- 设计&开发：6.26-6.27(done)
- 代码评审：6.30(done)
- 提测：7.2(doing)
- 上线：待定